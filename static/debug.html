<html>
  <head>
    <script type="text/javascript" src="/cosmopolite/static/cosmopolite.js" charset="UTF-8"></script>
    <style>
a {
  text-decoration: none;
}
    </style>
  </head>
  <body>
    <div>Google user: <span id="google_user"></span></div>

    <div>
      <div>
        Key:
        <select id="keys"></select>
        <input type="button" id="set" value="Set">
        <input type="button" id="add" value="Add">
      </div>
      <div>
        Last set:
        <span id="last_set"></span>
      </div>
      <div>
        <input type="checkbox" id="public"> Public
      </div>
      <div>
        <textarea id="value" rows="10" cols="40"></textarea>
      </div>
    </div>
    <script>
var keys = document.getElementById('keys');
var value = document.getElementById('value');
var last_set = document.getElementById('last_set');
var is_public = document.getElementById('public');

var selectKey = function(new_key) {
  keys.value = new_key;
  keys.dispatchEvent(new CustomEvent('change'));
};

var addKey = function(new_key, index) {
  var option = document.createElement('option');
  option.text = new_key;
  keys.options.add(option, index);
  if (keys.options.length == 1) {
    selectKey(new_key);
  }
};

window.addEventListener('load', function() {
  var googleUser = document.getElementById('google_user');

  var callbacks = {
    onLogin: function(username, logout_url) {
      googleUser.innerHTML =
        username +
        ' <a href="' + logout_url + '" target="_blank">(log out)</a>';
    },
    onLogout: function(login_url) {
      googleUser.innerHTML =
        '<a href="' + login_url + '" target="_blank">(log in)</a>';
    },
    onStateChange: function(new_key, new_value) {
      for (var i = 0; i < keys.options.length; ++i) {
        if (keys.options[i].value == new_key) {
          return;
        };
        if (keys.options[i].value > new_key) {
          addKey(new_key, i);
          return;
        };
      };
      // Sorts at the end
      addKey(new_key, keys.options.length);
    },
  };

  var debug = new cosmopolite.Client(callbacks);

  document.getElementById('set').addEventListener('click', function() {
    debug.setValue(keys.value, value.value, is_public.checked);
  });

  document.getElementById('add').addEventListener('click', function() {
    var new_key = prompt('New key name:');
    if (new_key === null) {
      return;
    }
    debug.setValue(new_key, '');
    selectKey(new_key);
  });

  document.getElementById('keys').addEventListener('change', function() {
    var value_obj = debug.getValue(keys.value);
    value.value = value_obj.value;
    last_set.innerHTML = (new Date(value_obj.last_set * 1000)).toString();
    is_public.checked = value_obj['public'];
  });
});
    </script>
  </body>
</html>
